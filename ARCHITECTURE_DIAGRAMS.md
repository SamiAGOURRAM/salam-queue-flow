# ğŸ›ï¸ QueueMed - Architecture Diagrams

Visual representation of the system architecture transformation.

---

## ğŸ“Š Current Architecture (Before)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Browser / Client                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              React Components (UI)                      â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  â€¢ EnhancedQueueManager                                 â”‚    â”‚
â”‚  â”‚  â€¢ BookingFlow                                          â”‚    â”‚
â”‚  â”‚  â€¢ ClinicQueue                                          â”‚    â”‚
â”‚  â”‚  â€¢ PatientDashboard                                     â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  âš ï¸ Business logic mixed with UI                        â”‚    â”‚
â”‚  â”‚  âš ï¸ Direct database access via Supabase client          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â”‚ supabase.from('table')            â”‚
â”‚                              â–¼                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â–¼                                    â”‚
â”‚                    Supabase Platform                              â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Edge Functions     â”‚  â”‚      PostgreSQL Database         â”‚  â”‚
â”‚  â”‚  (Deno Runtime)     â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚                     â”‚  â”‚  â€¢ clinics                       â”‚  â”‚
â”‚  â”‚  â€¢ smart-queue-     â”‚  â”‚  â€¢ appointments                  â”‚  â”‚
â”‚  â”‚    manager          â”‚  â”‚  â€¢ absent_patients               â”‚  â”‚
â”‚  â”‚  â€¢ send-sms         â”‚  â”‚  â€¢ queue_overrides               â”‚  â”‚
â”‚  â”‚  â€¢ send-staff-      â”‚  â”‚  â€¢ notification_templates        â”‚  â”‚
â”‚  â”‚    invitation       â”‚  â”‚  â€¢ profiles                      â”‚  â”‚
â”‚  â”‚  â€¢ update-queue-    â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚    state            â”‚  â”‚  âœ… Row Level Security (RLS)     â”‚  â”‚
â”‚  â”‚                     â”‚  â”‚  âœ… Proper indexes                â”‚  â”‚
â”‚  â”‚  âš ï¸ Hard to test    â”‚  â”‚  âœ… Normalized schema             â”‚  â”‚
â”‚  â”‚  âš ï¸ Deno-specific   â”‚  â”‚                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                            â”‚                         â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Auth               â”‚  â”‚     Realtime Subscriptions       â”‚  â”‚
â”‚  â”‚  â€¢ JWT tokens       â”‚  â”‚  â€¢ Queue updates                  â”‚  â”‚
â”‚  â”‚  â€¢ User sessions    â”‚  â”‚  â€¢ Live notifications             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   External APIs      â”‚
                    â”‚   â€¢ Twilio (SMS)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Problems**:
- âŒ Business logic scattered (Components, Edge Functions, DB Triggers)
- âŒ Tight coupling to Supabase
- âŒ Hard to test (no mocking layer)
- âŒ No API for external consumers
- âŒ Components directly access database
- âŒ Edge Functions hard to containerize

---

## ğŸ¯ Target Architecture (After - Modular Monolith)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PRESENTATION LAYER                                   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  React SPA   â”‚  â”‚  Mobile App  â”‚  â”‚ API Gateway  â”‚                  â”‚
â”‚  â”‚   (Web UI)   â”‚  â”‚   (Future)   â”‚  â”‚ (AI Agents)  â”‚                  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚                  â”‚
â”‚  â”‚  Components  â”‚  â”‚  React Nativeâ”‚  â”‚  REST API    â”‚                  â”‚
â”‚  â”‚  use hooks   â”‚  â”‚  components  â”‚  â”‚  /v1/queue   â”‚                  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  /v1/clinics â”‚                  â”‚
â”‚  â”‚  âœ… No DB    â”‚  â”‚  âœ… No DB    â”‚  â”‚              â”‚                  â”‚
â”‚  â”‚     access   â”‚  â”‚     access   â”‚  â”‚  âœ… OpenAPI  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                  â”‚                  â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â”‚  useQueueService â”‚                  â”‚ HTTP/JSON
          â”‚  useClinicServiceâ”‚                  â”‚
          â”‚                  â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â–¼                  â–¼                  â–¼                          â”‚
â”‚              APPLICATION LAYER (Service Orchestration)                   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ QueueService    â”‚  â”‚NotificationSvc  â”‚  â”‚ ClinicService   â”‚         â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚
â”‚  â”‚â€¢ getQueueStatus â”‚  â”‚â€¢ sendSMS        â”‚  â”‚â€¢ getClinic      â”‚         â”‚
â”‚  â”‚â€¢ callNext       â”‚  â”‚â€¢ sendEmail      â”‚  â”‚â€¢ updateSettings â”‚         â”‚
â”‚  â”‚â€¢ markAbsent     â”‚  â”‚â€¢ sendPush       â”‚  â”‚â€¢ addStaff       â”‚         â”‚
â”‚  â”‚â€¢ lateArrival    â”‚  â”‚â€¢ getTemplates   â”‚  â”‚                 â”‚         â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚
â”‚  â”‚âœ… Testable      â”‚  â”‚âœ… Testable      â”‚  â”‚âœ… Testable      â”‚         â”‚
â”‚  â”‚âœ… Reusable      â”‚  â”‚âœ… Channels      â”‚  â”‚âœ… Clear API     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                    â”‚                     â”‚                     â”‚
â”‚         â”‚  Publishes Events  â”‚                     â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                              â–¼                                           â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                   â”‚     Event Bus        â”‚                               â”‚
â”‚                   â”‚  (Pub/Sub Pattern)   â”‚                               â”‚
â”‚                   â”‚                      â”‚                               â”‚
â”‚                   â”‚ â€¢ PatientCalled      â”‚                               â”‚
â”‚                   â”‚ â€¢ PatientAbsent      â”‚                               â”‚
â”‚                   â”‚ â€¢ QueueUpdated       â”‚                               â”‚
â”‚                   â”‚                      â”‚                               â”‚
â”‚                   â”‚ âœ… Loose coupling    â”‚                               â”‚
â”‚                   â”‚ âœ… Async events      â”‚                               â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Uses Domain Models
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DOMAIN LAYER (Business Logic)                        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Queue Domain      â”‚  â”‚  Clinic Domain     â”‚  â”‚ Patient Domain   â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚  Aggregates:       â”‚  â”‚  Aggregates:       â”‚  â”‚ Entities:        â”‚  â”‚
â”‚  â”‚  â€¢ QueueAggregate  â”‚  â”‚  â€¢ ClinicAggregate â”‚  â”‚ â€¢ Patient        â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚ â€¢ Appointment    â”‚  â”‚
â”‚  â”‚  Entities:         â”‚  â”‚  Entities:         â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚  â€¢ Patient         â”‚  â”‚  â€¢ Clinic          â”‚  â”‚ Value Objects:   â”‚  â”‚
â”‚  â”‚  â€¢ Appointment     â”‚  â”‚  â€¢ Staff           â”‚  â”‚ â€¢ PhoneNumber    â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚ â€¢ EmailAddress   â”‚  â”‚
â”‚  â”‚  Value Objects:    â”‚  â”‚  Value Objects:    â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚  â€¢ QueuePosition   â”‚  â”‚  â€¢ Address         â”‚  â”‚ Events:          â”‚  â”‚
â”‚  â”‚  â€¢ GracePeriod     â”‚  â”‚  â€¢ WorkingHours    â”‚  â”‚ â€¢ PatientJoined  â”‚  â”‚
â”‚  â”‚  â€¢ WaitTime        â”‚  â”‚                    â”‚  â”‚ â€¢ PatientLeft    â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚  Business Rules:   â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚  Business Rules:   â”‚  â”‚  â€¢ Validate hours  â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚  â€¢ Grace period    â”‚  â”‚  â€¢ Staff limits    â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚  â€¢ Skip fairness   â”‚  â”‚  â€¢ Capacity        â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚  â€¢ Call logic      â”‚  â”‚                    â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚  âœ… Pure logic     â”‚  â”‚  âœ… Encapsulated   â”‚  â”‚ âœ… Testable      â”‚  â”‚
â”‚  â”‚  âœ… No I/O         â”‚  â”‚  âœ… No DB access    â”‚  â”‚ âœ… Reusable      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  Domain models contain ALL business logic and rules                      â”‚
â”‚  Services orchestrate domain models and infrastructure                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Persisted via Repositories
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  INFRASTRUCTURE LAYER (Data & External)                   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                      Repositories                            â”‚        â”‚
â”‚  â”‚                                                              â”‚        â”‚
â”‚  â”‚  â€¢ QueueRepository      â€¢ ClinicRepository                   â”‚        â”‚
â”‚  â”‚  â€¢ AppointmentRepositoryâ€¢ NotificationRepository             â”‚        â”‚
â”‚  â”‚                                                              â”‚        â”‚
â”‚  â”‚  âœ… Abstract data access                                     â”‚        â”‚
â”‚  â”‚  âœ… Mockable for tests                                       â”‚        â”‚
â”‚  â”‚  âœ… Can swap implementation (Supabase â†’ PostgreSQL)          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                              â”‚                                           â”‚
â”‚                              â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Database Access      â”‚  â”‚    External Services             â”‚         â”‚
â”‚  â”‚                      â”‚  â”‚                                  â”‚         â”‚
â”‚  â”‚ â€¢ Supabase Client    â”‚  â”‚  â€¢ Twilio (SMS)                  â”‚         â”‚
â”‚  â”‚ â€¢ PostgreSQL         â”‚  â”‚  â€¢ SendGrid (Email - Future)     â”‚         â”‚
â”‚  â”‚ â€¢ RLS Policies       â”‚  â”‚  â€¢ Firebase (Push - Future)      â”‚         â”‚
â”‚  â”‚ â€¢ Real-time subs     â”‚  â”‚  â€¢ WhatsApp API (Future)         â”‚         â”‚
â”‚  â”‚                      â”‚  â”‚                                  â”‚         â”‚
â”‚  â”‚ âœ… Secure (RLS)      â”‚  â”‚  âœ… Wrapped in services          â”‚         â”‚
â”‚  â”‚ âœ… Optimized queries â”‚  â”‚  âœ… Retry logic                  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                          â”‚
â”‚  Infrastructure layer handles ALL external communication                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CROSS-CUTTING CONCERNS                                â”‚
â”‚                                                                          â”‚
â”‚  â€¢ Logger (structured JSON logging)                                      â”‚
â”‚  â€¢ Error Handler (global error catching)                                 â”‚
â”‚  â€¢ Validator (Zod schemas)                                               â”‚
â”‚  â€¢ Cache (Redis - Future)                                                â”‚
â”‚  â€¢ Monitoring (Sentry, metrics)                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Benefits**:
- âœ… Clear separation of concerns (4 layers)
- âœ… Testable business logic (domain layer)
- âœ… Reusable services (application layer)
- âœ… Flexible infrastructure (easy to swap)
- âœ… API-ready for AI agents
- âœ… Container-ready for scaling

---

## ğŸ”„ Service Interaction Flow

### Example: Call Next Patient in Queue

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React UI  â”‚ User clicks "Call Next Patient"
â”‚  Component  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ useQueueService.callNextPatient(clinicId, staffId)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Layer                       â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚         QueueService.callNextPatient()       â”‚       â”‚
â”‚  â”‚                                              â”‚       â”‚
â”‚  â”‚  1. Load queue from repository               â”‚       â”‚
â”‚  â”‚  2. Call domain logic (QueueAggregate)       â”‚       â”‚
â”‚  â”‚  3. Persist changes via repository           â”‚       â”‚
â”‚  â”‚  4. Publish PatientCalledEvent               â”‚       â”‚
â”‚  â”‚  5. Return result                            â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚              â”‚              â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚              â”‚              â”‚
    â”Œâ”€â”€â”€â”€â”€â”˜              â”‚              â””â”€â”€â”€â”€â”€â”
    â”‚                    â”‚                    â”‚
    â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Repository  â”‚  â”‚ Domain Layer     â”‚  â”‚ Event Bus      â”‚
â”‚            â”‚  â”‚                  â”‚  â”‚                â”‚
â”‚getQueue()  â”‚  â”‚QueueAggregate    â”‚  â”‚publish()       â”‚
â”‚save()      â”‚  â”‚.callNext()       â”‚  â”‚                â”‚
â”‚            â”‚  â”‚                  â”‚  â”‚                â”‚
â”‚            â”‚  â”‚Business Rules:   â”‚  â”‚Listeners:      â”‚
â”‚            â”‚  â”‚â€¢ Find present    â”‚  â”‚â€¢ Notification  â”‚
â”‚            â”‚  â”‚â€¢ Skip absent     â”‚  â”‚  Service       â”‚
â”‚            â”‚  â”‚â€¢ Update counts   â”‚  â”‚â€¢ Analytics     â”‚
â”‚            â”‚  â”‚â€¢ Validate state  â”‚  â”‚â€¢ UI updates    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                        â”‚
     â”‚                                        â”‚
     â–¼                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Infrastructure   â”‚              â”‚ Notification       â”‚
â”‚                  â”‚              â”‚ Service            â”‚
â”‚ Supabase Client  â”‚              â”‚                    â”‚
â”‚ â€¢ Update DB      â”‚              â”‚ â€¢ Send SMS         â”‚
â”‚ â€¢ RLS check      â”‚              â”‚ â€¢ Track budget     â”‚
â”‚ â€¢ Real-time push â”‚              â”‚ â€¢ Log analytics    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Flow Steps**:
1. UI calls `useQueueService.callNextPatient()`
2. Service loads current queue (via Repository)
3. Service delegates to Domain Model (QueueAggregate)
4. Domain Model applies business rules (pure logic, no I/O)
5. Service persists changes (via Repository)
6. Service publishes `PatientCalledEvent` (Event Bus)
7. NotificationService listens and sends SMS
8. Repository triggers real-time update (Supabase Realtime)
9. UI receives update and re-renders

**Benefits of this flow**:
- Each layer has single responsibility
- Business logic (step 4) is pure and testable
- Services orchestrate but don't implement logic
- Events enable loose coupling
- Easy to add new features (just subscribe to events)

---

## ğŸ“¦ Directory Structure

```
src/
â”œâ”€â”€ services/                    # Application Layer
â”‚   â”œâ”€â”€ queue/
â”‚   â”‚   â”œâ”€â”€ QueueService.ts      # Main service
â”‚   â”‚   â”œâ”€â”€ models/              # Domain Layer
â”‚   â”‚   â”‚   â”œâ”€â”€ QueueAggregate.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ Patient.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ Appointment.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ QueuePosition.ts (Value Object)
â”‚   â”‚   â”‚   â””â”€â”€ GracePeriod.ts   (Value Object)
â”‚   â”‚   â”œâ”€â”€ events/              # Domain Events
â”‚   â”‚   â”‚   â”œâ”€â”€ PatientCalledEvent.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ PatientAbsentEvent.ts
â”‚   â”‚   â”‚   â””â”€â”€ QueueUpdatedEvent.ts
â”‚   â”‚   â”œâ”€â”€ repositories/        # Infrastructure Layer
â”‚   â”‚   â”‚   â””â”€â”€ QueueRepository.ts
â”‚   â”‚   â””â”€â”€ api/                 # API Contracts
â”‚   â”‚       â””â”€â”€ QueueAPI.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ notification/
â”‚   â”‚   â”œâ”€â”€ NotificationService.ts
â”‚   â”‚   â”œâ”€â”€ channels/
â”‚   â”‚   â”‚   â”œâ”€â”€ SMSChannel.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ EmailChannel.ts
â”‚   â”‚   â”‚   â””â”€â”€ WhatsAppChannel.ts
â”‚   â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â”‚   â””â”€â”€ TemplateEngine.ts
â”‚   â”‚   â””â”€â”€ api/
â”‚   â”‚       â””â”€â”€ NotificationAPI.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ clinic/
â”‚   â”‚   â”œâ”€â”€ ClinicService.ts
â”‚   â”‚   â”œâ”€â”€ StaffService.ts
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ events/
â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â””â”€â”€ api/
â”‚   â”‚
â”‚   â”œâ”€â”€ appointment/
â”‚   â”‚   â”œâ”€â”€ AppointmentService.ts
â”‚   â”‚   â”œâ”€â”€ BookingService.ts
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚
â”‚   â””â”€â”€ shared/                  # Cross-Cutting Concerns
â”‚       â”œâ”€â”€ events/
â”‚       â”‚   â””â”€â”€ EventBus.ts
â”‚       â”œâ”€â”€ logging/
â”‚       â”‚   â””â”€â”€ Logger.ts
â”‚       â”œâ”€â”€ errors/
â”‚       â”‚   â””â”€â”€ AppError.ts
â”‚       â””â”€â”€ validation/
â”‚           â””â”€â”€ Validator.ts
â”‚
â”œâ”€â”€ api/                         # API Layer (Optional)
â”‚   â””â”€â”€ v1/
â”‚       â”œâ”€â”€ index.ts             # API Server
â”‚       â”œâ”€â”€ routes/
â”‚       â”‚   â”œâ”€â”€ queue.ts
â”‚       â”‚   â”œâ”€â”€ clinics.ts
â”‚       â”‚   â””â”€â”€ appointments.ts
â”‚       â”œâ”€â”€ schemas/             # Zod Schemas
â”‚       â”‚   â””â”€â”€ queue.schema.ts
â”‚       â””â”€â”€ middleware/
â”‚           â”œâ”€â”€ auth.ts
â”‚           â”œâ”€â”€ logging.ts
â”‚           â””â”€â”€ errorHandler.ts
â”‚
â”œâ”€â”€ hooks/                       # React Hooks (Presentation)
â”‚   â”œâ”€â”€ useQueueService.ts
â”‚   â”œâ”€â”€ useClinicService.ts
â”‚   â””â”€â”€ useAuth.tsx
â”‚
â”œâ”€â”€ components/                  # UI Components
â”‚   â”œâ”€â”€ clinic/
â”‚   â”‚   â”œâ”€â”€ QueueManager.tsx     # Uses useQueueService
â”‚   â”‚   â””â”€â”€ EnhancedQueueManager.tsx
â”‚   â””â”€â”€ booking/
â”‚       â””â”€â”€ BookingFlow.tsx
â”‚
â””â”€â”€ test/                        # Testing Infrastructure
    â”œâ”€â”€ setup.ts
    â”œâ”€â”€ fixtures/
    â””â”€â”€ mocks/
```

---

## ğŸ”€ Data Flow Diagrams

### 1. Queue Status Query (Read)

```
User
 â”‚
 â”‚ GET /queue
 â–¼
React Component
 â”‚
 â”‚ useQueueService.getQueueStatus()
 â–¼
QueueService
 â”‚
 â”‚ repository.getActiveQueue()
 â”‚ repository.getCurrentPatient()
 â”‚ repository.getAbsentPatients()
 â–¼
QueueRepository
 â”‚
 â”‚ supabase.from('appointments').select()
 â–¼
Supabase (PostgreSQL)
 â”‚
 â”‚ RLS check â†’ Filter by clinic_id
 â–¼
Return Data
 â”‚
 â–¼
Transform to Domain Models
 â”‚
 â–¼
Calculate Statistics
 â”‚
 â–¼
Return QueueStatus DTO
 â”‚
 â–¼
React Component Updates UI
```

---

### 2. Call Next Patient (Write with Events)

```
User clicks "Call Next"
 â”‚
 â–¼
React Component
 â”‚
 â”‚ useQueueService.callNextPatient(clinicId, staffId)
 â–¼
QueueService
 â”‚
 â”œâ”€â–º 1. Load queue (Repository)
 â”‚    â”‚
 â”‚    â–¼
 â”‚   QueueRepository.getActiveQueue()
 â”‚    â”‚
 â”‚    â–¼
 â”‚   Supabase query
 â”‚    â”‚
 â”‚    â””â”€â–º Returns patients[]
 â”‚
 â”œâ”€â–º 2. Business logic (Domain)
 â”‚    â”‚
 â”‚    â–¼
 â”‚   QueueAggregate.callNextPatient()
 â”‚    â”‚
 â”‚    â”œâ”€â–º Find next present patient
 â”‚    â”œâ”€â–º Increment skip count for bypassed
 â”‚    â”œâ”€â–º Validate state
 â”‚    â””â”€â–º Return result
 â”‚
 â”œâ”€â–º 3. Persist changes (Repository)
 â”‚    â”‚
 â”‚    â–¼
 â”‚   QueueRepository.save()
 â”‚    â”‚
 â”‚    â”œâ”€â–º Update appointment status
 â”‚    â”œâ”€â–º Update skip counts
 â”‚    â””â”€â–º Create queue_override audit log
 â”‚
 â”œâ”€â–º 4. Publish event (Event Bus)
 â”‚    â”‚
 â”‚    â–¼
 â”‚   eventBus.publish(PatientCalledEvent)
 â”‚    â”‚
 â”‚    â”œâ”€â–º NotificationService listens
 â”‚    â”‚    â”‚
 â”‚    â”‚    â”œâ”€â–º Send "Your turn" SMS to patient
 â”‚    â”‚    â””â”€â–º Send "Skipped" SMS to bypassed patients
 â”‚    â”‚
 â”‚    â”œâ”€â–º AnalyticsService listens
 â”‚    â”‚    â””â”€â–º Log event for ML training
 â”‚    â”‚
 â”‚    â””â”€â–º UI listens (Supabase Realtime)
 â”‚         â””â”€â–º Re-render queue display
 â”‚
 â””â”€â–º 5. Return result to UI
      â”‚
      â–¼
     Success toast
     Queue UI updates
```

---

## ğŸ§ª Testing Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Testing Pyramid                         â”‚
â”‚                                                       â”‚
â”‚                    /\                                 â”‚
â”‚                   /  \   E2E Tests                    â”‚
â”‚                  /    \  (5% - Critical paths)        â”‚
â”‚                 /â”€â”€â”€â”€â”€â”€\                              â”‚
â”‚                /        \  Integration Tests          â”‚
â”‚               /          \ (15% - Service workflows)  â”‚
â”‚              /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\                           â”‚
â”‚             /              \ Unit Tests               â”‚
â”‚            /                \ (80% - Services,        â”‚
â”‚           /                  \ Domain models)         â”‚
â”‚          /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\                       â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Unit Tests (80%):
â”œâ”€â”€ Domain Models
â”‚   â”œâ”€â”€ QueueAggregate.test.ts      (Pure logic, no mocks)
â”‚   â”œâ”€â”€ Patient.test.ts
â”‚   â””â”€â”€ ValueObjects.test.ts
â”‚
â”œâ”€â”€ Services
â”‚   â”œâ”€â”€ QueueService.test.ts        (Mock repository)
â”‚   â””â”€â”€ NotificationService.test.ts (Mock channels)
â”‚
â””â”€â”€ Repositories
    â””â”€â”€ QueueRepository.test.ts     (Mock Supabase)

Integration Tests (15%):
â”œâ”€â”€ Queue workflow
â”‚   â””â”€â”€ call-next-patient.test.ts   (Service + Repo + DB)
â”‚
â””â”€â”€ Event handlers
    â””â”€â”€ event-bus.test.ts           (Full event flow)

E2E Tests (5%):
â””â”€â”€ Critical user journeys
    â”œâ”€â”€ patient-booking.test.ts
    â””â”€â”€ queue-management.test.ts
```

---

## ğŸ³ Containerization Strategy (Future)

### Phase 1: Current (Supabase Edge Functions)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Supabase Platform             â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Edge Functions (Deno) â”‚    â”‚
â”‚  â”‚  â€¢ smart-queue-manager â”‚    â”‚
â”‚  â”‚  â€¢ send-sms            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚             â”‚                   â”‚
â”‚             â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  PostgreSQL            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: Hybrid (Months 4-6)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Docker Containers             â”‚     â”‚  Supabase Platform   â”‚
â”‚                                 â”‚     â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Server (Node.js)  â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚  PostgreSQL    â”‚  â”‚
â”‚  â”‚  â€¢ Queue Service       â”‚    â”‚     â”‚  â”‚  (Database)    â”‚  â”‚
â”‚  â”‚  â€¢ Notification Svc    â”‚    â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  â€¢ REST APIs           â”‚    â”‚     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚             â”‚                   â”‚     â”‚  â”‚  Auth          â”‚  â”‚
â”‚             â–¼                   â”‚     â”‚  â”‚  (Keep for now)â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  Redis Cache           â”‚    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 3: Full Container (Months 7-12)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Kubernetes Cluster                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   API        â”‚  â”‚ Notification â”‚  â”‚   Queue     â”‚  â”‚
â”‚  â”‚   Service    â”‚  â”‚   Service    â”‚  â”‚  Service    â”‚  â”‚
â”‚  â”‚  (3 pods)    â”‚  â”‚  (2 pods)    â”‚  â”‚  (2 pods)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                 â”‚         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                            â–¼                           â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                  â”‚   Event Bus      â”‚                  â”‚
â”‚                  â”‚   (Redis)        â”‚                  â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                            â”‚                           â”‚
â”‚                            â–¼                           â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                  â”‚   PostgreSQL     â”‚                  â”‚
â”‚                  â”‚   (Cloud SQL)    â”‚                  â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Security Layers                        â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  1. Authentication                          â”‚    â”‚
â”‚  â”‚     â€¢ JWT tokens (Supabase Auth)            â”‚    â”‚
â”‚  â”‚     â€¢ API keys for external services        â”‚    â”‚
â”‚  â”‚     â€¢ Session management                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                     â”‚                               â”‚
â”‚                     â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  2. Authorization                           â”‚    â”‚
â”‚  â”‚     â€¢ Role-based (RBAC)                     â”‚    â”‚
â”‚  â”‚     â€¢ Resource-based (RLS)                  â”‚    â”‚
â”‚  â”‚     â€¢ Clinic isolation (multi-tenant)       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                     â”‚                               â”‚
â”‚                     â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  3. Row Level Security (RLS)                â”‚    â”‚
â”‚  â”‚     â€¢ Patients see only own data            â”‚    â”‚
â”‚  â”‚     â€¢ Staff see only clinic data            â”‚    â”‚
â”‚  â”‚     â€¢ Owners manage clinic                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                     â”‚                               â”‚
â”‚                     â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  4. Data Encryption                         â”‚    â”‚
â”‚  â”‚     â€¢ At rest (database encryption)         â”‚    â”‚
â”‚  â”‚     â€¢ In transit (HTTPS/TLS)                â”‚    â”‚
â”‚  â”‚     â€¢ Sensitive fields (PII)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                     â”‚                               â”‚
â”‚                     â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  5. Audit Logging                           â”‚    â”‚
â”‚  â”‚     â€¢ All data access logged                â”‚    â”‚
â”‚  â”‚     â€¢ User actions tracked                  â”‚    â”‚
â”‚  â”‚     â€¢ Compliance reports                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Monitoring & Observability

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Application Services                      â”‚
â”‚  â€¢ QueueService                                      â”‚
â”‚  â€¢ NotificationService                               â”‚
â”‚  â€¢ ClinicService                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚              â”‚              â”‚
     Logs â”‚              â”‚ Metrics      â”‚ Traces
          â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Logger     â”‚  â”‚  Metrics     â”‚  â”‚  Tracing     â”‚
â”‚              â”‚  â”‚  Collector   â”‚  â”‚  (Optional)  â”‚
â”‚ â€¢ Structured â”‚  â”‚              â”‚  â”‚              â”‚
â”‚ â€¢ JSON       â”‚  â”‚ â€¢ Requests   â”‚  â”‚ â€¢ Spans      â”‚
â”‚ â€¢ Levels     â”‚  â”‚ â€¢ Errors     â”‚  â”‚ â€¢ Context    â”‚
â”‚ â€¢ Context    â”‚  â”‚ â€¢ Latency    â”‚  â”‚ â€¢ Propagate  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚                 â”‚
       â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Log         â”‚  â”‚  Grafana/    â”‚  â”‚  Jaeger/     â”‚
â”‚  Aggregation â”‚  â”‚  Datadog     â”‚  â”‚  Zipkin      â”‚
â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
â”‚ â€¢ LogTail    â”‚  â”‚ â€¢ Dashboards â”‚  â”‚ â€¢ Trace view â”‚
â”‚ â€¢ Datadog    â”‚  â”‚ â€¢ Alerts     â”‚  â”‚ â€¢ Timeline   â”‚
â”‚ â€¢ ELK        â”‚  â”‚ â€¢ Analytics  â”‚  â”‚ â€¢ Dependenciesâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Alerting   â”‚
                  â”‚              â”‚
                  â”‚ â€¢ PagerDuty  â”‚
                  â”‚ â€¢ Slack      â”‚
                  â”‚ â€¢ Email      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Status**: Architecture defined âœ…  
**Next**: Implementation Phase  
**Timeline**: 12 weeks  
**Team**: Ready to build! ğŸš€
